# üß† –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ GPU –ü–∞–º—è—Ç—å—é –≤ RAG –°–∏—Å—Ç–µ–º–µ

## üö® –ü—Ä–æ–±–ª–µ–º–∞: CUDA Out of Memory

### –ü—Ä–∏—á–∏–Ω—ã –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è:
1. **–ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π –≤ GPU –ø–∞–º—è—Ç–∏** –ø—Ä–∏ –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω—ã—Ö –∑–∞–ø—É—Å–∫–∞—Ö
2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—á–∏—Å—Ç–∫–∏** PyTorch –∫—ç—à–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏  
3. **–§—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏—è –ø–∞–º—è—Ç–∏** –∏–∑-–∑–∞ —Å–æ–∑–¥–∞–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤
4. **–£—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏** –≤ embedding –º–æ–¥–µ–ª—è—Ö –∏ FAISS –∏–Ω–¥–µ–∫—Å–∞—Ö

### –¢–∏–ø–∏—á–Ω–∞—è –æ—à–∏–±–∫–∞:
```
torch.OutOfMemoryError: CUDA out of memory. Tried to allocate 6.00 GiB. 
GPU 0 has a total capacity of 47.38 GiB of which 1.56 GiB is free.
```

## ‚úÖ –†–µ—à–µ–Ω–∏–µ: –°–∏—Å—Ç–µ–º–∞ –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ü–∞–º—è—Ç—å—é

### 1. üîß GPUMemoryManager (`gpu_utils.py`)

**–û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è GPU –ø–∞–º—è—Ç–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞** PyTorch –∫—ç—à–∞ –∏ —Å–±–æ—Ä–∫–∞ –º—É—Å–æ—Ä–∞
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä–æ–≥–æ–≤** –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏
- **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è** —Ä–∞–∑–º–µ—Ä–∞ –±–∞—Ç—á–µ–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–æ—Å—Ç—É–ø–Ω–æ–π –ø–∞–º—è—Ç–∏

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
```python
from gpu_utils import cleanup_gpu, monitor_gpu, gpu_manager

# –ë—ã—Å—Ç—Ä–∞—è –æ—á–∏—Å—Ç–∫–∞
cleanup_gpu()

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è
monitor_gpu()

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (>85%)
if gpu_manager.check_memory_threshold(85):
    cleanup_gpu()
```

### 2. üåê –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Web UI

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞:**
- **–ü–µ—Ä–µ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π** RAG –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
- **–ü–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∑–∞–ø—Ä–æ—Å–æ–º** (–µ—Å–ª–∏ –ø–∞–º—è—Ç—å >85%)
- **–ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞** 
- **–ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö** –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- **–ü—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç—ã** –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

**–ù–æ–≤—ã–µ endpoints:**
- `GET /memory-info` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –ø–∞–º—è—Ç–∏
- `POST /cleanup-memory` - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞

### 3. üõ°Ô∏è Graceful Shutdown

**–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã:**
```python
# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ SIGINT/SIGTERM
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ (atexit)
# –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤:
```bash
# –ë–∞–∑–æ–≤–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
python test_memory_management.py

# –°—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç
python test_memory_management.py --stress
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ GPU —É—Ç–∏–ª–∏—Ç:
```bash
python gpu_utils.py
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞–º—è—Ç–∏:
```python
info = gpu_manager.get_gpu_memory_info()
print(f"–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: {info['memory_usage_percent']:.1f}%")
print(f"–°–≤–æ–±–æ–¥–Ω–æ: {info['free_memory_gb']:.1f}GB")
```

### –ü–æ—Ä–æ–≥–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π:
- **75%** - –í—ã—Å–æ–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
- **85%** - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ (–∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞)
- **90%** - –ê–≤–∞—Ä–∏–π–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
```bash
# –í–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞—Å—à–∏—Ä—è–µ–º—ã—Ö —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –ø–∞–º—è—Ç–∏
export PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
export CUDA_VISIBLE_DEVICES=""
```

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ –±–∞—Ç—á–∞:
```python
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
optimal_batch = gpu_manager.get_optimal_batch_size(base_batch_size=32)
```

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –í –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ:
1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ `python web_ui.py`
2. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç –ø–∞–º—è—Ç—å
3. –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ø–æ—Ä–æ–≥–æ–≤ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞
4. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞–º—è—Ç–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –æ—Ç–≤–µ—Ç–∞—Ö

### –í CLI:
```bash
# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
python -c "from gpu_utils import monitor_gpu; monitor_gpu()"

# –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏  
python -c "from gpu_utils import cleanup_gpu; cleanup_gpu()"
```

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –æ—à–∏–±–æ–∫ –ø–∞–º—è—Ç–∏:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
   ```bash
   python gpu_utils.py
   ```

2. **–í—ã–ø–æ–ª–Ω–∏—Ç–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—É—é –æ—á–∏—Å—Ç–∫—É:**
   ```python
   from gpu_utils import aggressive_cleanup_gpu
   aggressive_cleanup_gpu()
   ```

3. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** —Å –æ—á–∏—Å—Ç–∫–æ–π:
   ```bash
   python -c "from gpu_utils import cleanup_gpu; cleanup_gpu()" && python web_ui.py
   ```

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã:
1. **–†–µ–≥—É–ª—è—Ä–Ω–æ –º–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
2. **–ù–µ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ** —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ RAG –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
3. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É** –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
4. **–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** –ø—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–µ
5. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é** `PYTORCH_CUDA_ALLOC_CONF`

### –ü—Ä–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏:
1. –£–º–µ–Ω—å—à–∏—Ç–µ —Ä–∞–∑–º–µ—Ä –±–∞—Ç—á–µ–π
2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ CPU –¥–ª—è —á–∞—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–π
3. –û—á–∏—â–∞–π—Ç–µ –ø–∞–º—è—Ç—å —á–∞—â–µ (–ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞)
4. –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–æ–ª–µ–µ –ª–µ–≥–∫–∏—Ö –º–æ–¥–µ–ª–µ–π

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- ‚ùå –£—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ö
- ‚ùå –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –º–æ–¥–µ–ª–µ–π
- ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ CUDA OOM

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏  
- ‚úÖ Graceful shutdown —Å –æ—á–∏—Å—Ç–∫–æ–π —Ä–µ—Å—É—Ä—Å–æ–≤
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –ø—Ä–∏ –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω—ã—Ö –∑–∞–ø—É—Å–∫–∞—Ö
